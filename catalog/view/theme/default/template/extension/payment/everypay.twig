<script src="/catalog/view/javascript/everypayModal.js"></script>
<div class="btn btn-primary pull-right btn-large" disabled="disabled" id="everypayBtn">Pay with card</div>
{% if iris_enabled %}
    {% if iris_callback_notice %}
    <div class="alert alert-danger">{{ iris_callback_notice }}</div>
    {% endif %}
<div id="everypay-iris-error" class="alert alert-danger" style="display:none;"></div>
{% endif %}

<script type="text/javascript">

    function loadEverypayScript(url, callback)
    {
        var head = document.getElementsByTagName('head')[0];
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = url;
        script.onreadystatechange = callback;
        script.onload = callback;
        head.appendChild(script);
    }

    {% if iris_enabled %}
    var irisRequestErrorText = '{{ text_iris_request_error|escape('js') }}';
    var irisCallbackErrorText = '{{ text_iris_callback_error|escape('js') }}';
    var irisErrorContainerId = 'everypay-iris-error';

    function hideIrisError() {
        var container = document.getElementById(irisErrorContainerId);
        if (!container) {
            return;
        }
        container.style.display = 'none';
        container.textContent = '';
    }

    function showIrisError(details, baseMessage) {
        var container = document.getElementById(irisErrorContainerId);
        if (!container) {
            return;
        }
        var message = baseMessage || irisRequestErrorText;
        if (details) {
            message += ' (' + details + ')';
        }
        container.textContent = message;
        container.style.display = 'block';
    }
    {% endif %}

    var calculate_installments = function (max_installments) {
        var installments = [];

        if (max_installments > 36)
            return installments;

        if (typeof max_installments != 'number' || max_installments > 36)
            return installments;

        var y = 2;
        for (let i = 2; i <= max_installments; i += y) {
            if (i >= 12)
                y = 12;

            installments.push(i);
        }
        return installments;
    }

    let modal = new window.EverypayModal();

    let payload = {
        pk: "{{ public_key}}",
        locale: "{{ test|slice(0,2)=="el" ? "el" : "en" }}",
        amount:  {{ total}},
        data: {
            billing: { addressLine1: "{{ billingAddress }}" }
        },
    };

    {% if installments %}
        payload.installments = calculate_installments({{ installments}})
    {% endif %}

    {% if iris_enabled %}
        (function() {
            var irisUuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0;
                var v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            var irisConfig = {
                merchantName: '{{ iris_merchant_name }}',
                country: '{{ iris_country }}',
                callbackUrl: '{{ iris_callback_url }}',
                md: '{{ iris_md }}',
                uuid: irisUuid
            };
            Object.defineProperty(irisConfig, 'sessionHandler', {
                value: function(sessionPayload) {
                    sessionPayload = sessionPayload || {};
                    if (!sessionPayload.uuid) {
                        sessionPayload.uuid = irisUuid;
                    }
                    if (!sessionPayload.md) {
                        sessionPayload.md = '{{ iris_md }}';
                    }
                    hideIrisError();
                    return fetch('{{ iris_session_url }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({
                            uuid: sessionPayload.uuid,
                            md: sessionPayload.md,
                            amount: {{ total }},
                            currency: '{{ currency_code|upper }}',
                            country: '{{ iris_country }}'
                        })
                    })
                    .then(function(response) { return response.json(); })
                    .then(function(json) {
                        if (!json || !json.success || !json.data || !json.data.signature) {
                            var message = (json && json.message) ? json.message : 'Invalid IRIS session response';
                            throw new Error(message);
                        }
                        irisConfig.uuid = json.data.uuid || sessionPayload.uuid || irisUuid;
                        payload.uuid = irisConfig.uuid;
                        return json.data.signature;
                    })
                    .catch(function(error) {
                        var details = (error && error.message) ? error.message : '';
                        showIrisError(details, irisRequestErrorText);
                        throw error;
                    });
                },
                enumerable: false,
                configurable: true,
                writable: true
            });
            if (!payload.otherPaymentMethods) {
                payload.otherPaymentMethods = {};
            }
            payload.otherPaymentMethods.iris = irisConfig;
            payload.md = '{{ iris_md }}';
            payload.uuid = irisUuid;
        })();
    {% endif %}

    let everypayUrl = 'https://js.everypay.gr/v3';

    {% if sandbox == 1 %}
     everypayUrl = 'https://sandbox-js.everypay.gr/v3';
    {% endif %}

    loadEverypayScript(everypayUrl, () => {
        everypay.payform(payload, (r) => {

            if (r.onLoad) {
                document.getElementById('everypayBtn').removeAttribute('disabled');
                document.getElementById('everypayBtn').addEventListener('click', modal.open)
            }

            if (r.response == 'success') {
                {% if iris_enabled %}
                // For IRIS payments, check if this is a card token or IRIS redirect
                // IRIS payments should NOT submit the form - EveryPay handles the redirect
                // Only card payments should submit the form to capture payment
                if (r.paymentMethod && r.paymentMethod === 'iris') {
                    // IRIS payment - do not submit form
                    // EveryPay will redirect to bank, then call our irisCallback
                    console.log('IRIS payment initiated - waiting for bank redirect');
                    return;
                }
                {% endif %}
                // Card payment - submit form to capture payment
                modal.destroy();
                document.getElementById('everypayTokenInput').value = r.token;
                document.getElementById('payment-card-form').submit();
            }
            {% if iris_enabled %}
            if (r.response && r.response !== 'success') {
                var irisFailureDetails = r.message || r.error || '';
                showIrisError(irisFailureDetails, irisCallbackErrorText);
            }
            {% endif %}
        });
    });


</script>


<form id="payment-card-form" method="POST" action=" {{ return_url}}">
    <input type="hidden" name="merchant_order_id" value=" {{ merchant_order_id}}" />
    <input type="hidden" name="everypayToken" id="everypayTokenInput" value="" />
    <div class="button-holder" style="float: right;"></div>
</form>
